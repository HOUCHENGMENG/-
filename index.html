<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>HCM的消息墙</title>
        <script src="./components/api/api.js"></script>
        <link rel="stylesheet" href="./main.css" />
        <link rel="stylesheet" href="./components/alert/alert.css" />
        <script src="./components/alert/alert.js"></script>
        <script>
            // api 实例
            const api = new Api("https://3yya.com/u/a1e87c66d73b4ca3/rest/app");
            // alert 实例
            const myAlert = new Alert(3500);
            async function render() {
                const posts = await api.getPosts();
                // document.querySelector(".posts").innerHTML = "";

                posts.results.forEach((data) => {
                    const postEle = document.createElement("div");
                    postEle.classList.add("post");
                    document.querySelector(".posts").append(postEle);
                    const pEle = document.createElement("p");
                    pEle.innerText = `${data.content}`;
                    postEle.prepend(pEle);
                    const postBottom = document.createElement("div");
                    postBottom.classList.add("post-bottom");
                    const timeEle = document.createElement("span");
                    timeEle.innerText = `${formatTime(data.publish_time)}`;
                    postBottom.prepend(timeEle);
                    const bottoms = document.createElement("div");
                    postBottom.append(bottoms);
                    const editBottom = document.createElement("button");
                    editBottom.classList.add("edit");
                    editBottom.innerText = "编辑";
                    bottoms.append(editBottom);
                    const deleteBottom = document.createElement("button");
                    deleteBottom.classList.add("delete");
                    deleteBottom.id = data.post_id;
                    deleteBottom.innerText = "删除";
                    deleteBottom.onclick = async () => {
                        await api.deletePosts(data.post_id);
                        postEle.remove();
                    };
                    bottoms.append(deleteBottom);
                    postEle.append(postBottom);
                    editBottom.onclick = editPost;
                    deleteBottom.onclick = deletePost;

                    //   document.querySelector(".posts").innerHTML += `
                    //             <div class="post">
                    //                 <p>${data.content}</p>
                    //                 <div class="post-bottom">
                    //                     <span>${formatTime(data.publish_time)}</span>
                    //                     <div>
                    //                         <button class="edit">编辑</button>
                    //                         <button class="delete">删除</button>
                    //                     </div>
                    //                 </div>
                    //             </div>
                    //             `;
                });
            }
            window.addEventListener("load", function () {
                // 显示发布框
                document.querySelector(".submit").onclick = function () {
                    document.querySelector(".post-submit").hidden = false;
                };
                //取消按钮，隐藏发布框
                document.querySelector(".cancel").onclick = function () {
                    hideTextarea();
                    clearTextarea();
                };
                //清空textarea
                function clearTextarea() {
                    document.querySelector("textarea").value = "";
                }
                //隐藏textarea
                function hideTextarea() {
                    document.querySelector(".post-submit").hidden = true;
                }
                //提交按钮，发布消息
                document.querySelector(".confirm").onclick = async function () {
                    const content =
                        document.querySelector(".input-content").value;
                    if (content.length < 10) {
                        myAlert.alertWarning("消息至少10个字符");
                        return;
                    }
                    if (content.length > 100) {
                        myAlert.alertWarning("消息不能多于100个字符");
                        return;
                    }
                    await api.publishPost(content);
                    myAlert.alertSuccess("发布成功");
                    clearTextarea();
                    hideTextarea();
                    document.querySelector(".posts").innerHTML = "";
                    render();
                };
            });
            //格式化时间戳
            function fillZero(number) {
                return number >= 10 ? number : `0${number}`;
            }
            function formatTime(time) {
                const postTime = new Date(time * 1000);
                return `${postTime.getFullYear()}-${fillZero(
                    postTime.getMonth() + 1
                )}-${fillZero(postTime.getDate())} ${fillZero(
                    postTime.getHours()
                )}:${fillZero(postTime.getMinutes())}`;
            }
            //删除消息
            function deletePost(event) {
                const confir = confirm("确定要删除吗？");
                if (confir) {
                    event.currentTarget.parentNode.parentNode.parentNode.remove();
                    api.deletePosts(event.currentTarget.id);
                    myAlert.alertSuccess("删除成功");
                } else {
                    return;
                }

                // render();
            }
            //编辑消息
            function editPost(event) {
                const editingPost = document.querySelector(".input-dialog");
                console.log(editingPost.firstElementChild.value);
                editingPost.firstElementChild.value =
                    event.currentTarget.parentNode.parentNode.previousSibling.innerText;
                event.currentTarget.parentNode.parentNode.parentNode.replaceWith(
                    editingPost
                );
                // event.currentTarget.parentNode.parentNode.parentNode.innerHTML = `
                //     <div class="post input-dialog">
                //         <textarea
                //             class="input-content"
                //             rows="5"
                //         >${event.currentTarget.parentNode.parentNode.previousSibling.innerText}</textarea>
                //         <div class="buttons">
                //             <button class="confirm">确认</button>
                //             <button class="cancel" onclick="cancel">取消</button>
                //         </div>
                //     </div>`;
            }
            render();
        </script>
    </head>
    <body>
        <div class="container">
            <header>
                <h2>消息墙</h2>
                <div class="search">
                    <input type="text" placeholder="输入你要搜索的内容" />
                    <button>搜索</button>
                    <button>清除</button>
                </div>
            </header>
            <main>
                <div class="post-submit" hidden>
                    <div class="post input-dialog">
                        <textarea
                            class="input-content"
                            placeholder="请输入消息"
                            rows="5"
                        ></textarea>
                        <div class="buttons">
                            <button class="confirm">确认</button>
                            <button class="cancel">取消</button>
                        </div>
                    </div>
                </div>
                <div class="posts">
                    <!-- <div class="post">
                      <p>New Message : Hello World</p>
                      <div class="post-bottom">
                        <span>2022-11-23 09:29</span>
                        <div>
                          <button class="edit">编辑</button>
                          <button class="delete">删除</button>
                        </div>
                      </div>
                    </div> -->
                </div>
            </main>
            <button class="submit">发布</button>
        </div>
    </body>
</html>
