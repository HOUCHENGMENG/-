<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HCM的消息墙</title>
    <script src="./components/api/api.js"></script>
    <link rel="stylesheet" href="./main.css" />
    <link rel="stylesheet" href="./components/alert/alert.css" />
    <script src="./components/alert/alert.js"></script>
    <script>
      // api 实例
      const api = new Api("https://3yya.com/u/a1e87c66d73b4ca3/rest/app");
      // alert 实例
      const myAlert = new Alert(3500);
      async function render() {
        const posts = await api.getPosts();
        const arr = posts.results;
        createDom(arr);
        // posts.results.forEach((data) => {
        //   const postEle = document.createElement("div");
        //   postEle.classList.add("post");
        //   document.querySelector(".posts").append(postEle);
        //   const pEle = document.createElement("p");
        //   pEle.innerText = `${data.content}`;
        //   postEle.prepend(pEle);
        //   const postBottom = document.createElement("div");
        //   postBottom.classList.add("post-bottom");
        //   const timeEle = document.createElement("span");
        //   timeEle.innerText = `${formatTime(data.publish_time)}`;
        //   postBottom.prepend(timeEle);
        //   const bottoms = document.createElement("div");
        //   postBottom.append(bottoms);
        //   const editBottom = document.createElement("button");
        //   editBottom.classList.add("edit");
        //   editBottom.innerText = "编辑";
        //   bottoms.append(editBottom);
        //   const deleteBottom = document.createElement("button");
        //   deleteBottom.classList.add("delete");
        //   deleteBottom.id = data.post_id;
        //   deleteBottom.innerText = "删除";
        //   deleteBottom.onclick = async () => {
        //     await api.deletePosts(data.post_id);
        //     postEle.remove();
        //   };
        //   bottoms.append(deleteBottom);
        //   postEle.append(postBottom);
        //   editBottom.onclick = editPost;
        //   deleteBottom.onclick = deletePost;

        // });
      }
      //渲染DOM元素
      function createDom(posts) {
        document.querySelector(".posts").innerHTML = "";

        posts.forEach((data) => {
          const postEle = document.createElement("div");
          postEle.classList.add("post");
          document.querySelector(".posts").append(postEle);
          const pEle = document.createElement("p");
          pEle.innerText = `${data.content}`;
          postEle.prepend(pEle);
          const postBottom = document.createElement("div");
          postBottom.classList.add("post-bottom");
          const timeEle = document.createElement("span");
          timeEle.innerText = `${formatTime(data.publish_time)}`;
          postBottom.prepend(timeEle);
          const bottoms = document.createElement("div");
          postBottom.append(bottoms);
          const editBottom = document.createElement("button");
          editBottom.classList.add("edit");
          editBottom.innerText = "编辑";
          bottoms.append(editBottom);
          const deleteBottom = document.createElement("button");
          deleteBottom.classList.add("delete");
          deleteBottom.id = data.post_id;
          deleteBottom.innerText = "删除";
          deleteBottom.onclick = async () => {
            await api.deletePosts(data.post_id);
            postEle.remove();
          };
          bottoms.append(deleteBottom);
          postEle.append(postBottom);
          editBottom.onclick = editPost;
          deleteBottom.onclick = deletePost;
        });
      }
      window.addEventListener("load", function () {
        //搜索按钮
        document.querySelector(".searchButton").onclick = search;
        //清除按钮
        document.querySelector(".clearButton").onclick = clear;
        // 显示发布框
        document.querySelector(".submit").onclick = function () {
          document.querySelector(".post-submit").hidden = false;
        };
        //取消按钮，隐藏发布框
        document.querySelector(".cancel").onclick = function () {
          hideTextarea();
          clearTextarea();
        };
        //清空textarea
        function clearTextarea() {
          document.querySelector("textarea").value = "";
        }
        //隐藏textarea
        function hideTextarea() {
          document.querySelector(".post-submit").hidden = true;
        }
        //提交按钮，发布消息
        document.querySelector(".confirm").onclick = async function () {
          const content = document.querySelector(".input-content").value;
          if (content.length < 10) {
            myAlert.alertWarning("消息至少10个字符");
            return;
          }
          if (content.length > 100) {
            myAlert.alertWarning("消息不能多于100个字符");
            return;
          }
          await api.publishPost(content);
          myAlert.alertSuccess("发布成功");
          clearTextarea();
          hideTextarea();
          document.querySelector(".posts").innerHTML = "";
          render();
        };
      });
      //格式化时间戳
      function fillZero(number) {
        return number >= 10 ? number : `0${number}`;
      }
      function formatTime(time) {
        const postTime = new Date(time * 1000);
        return `${postTime.getFullYear()}-${fillZero(
          postTime.getMonth() + 1
        )}-${fillZero(postTime.getDate())} ${fillZero(
          postTime.getHours()
        )}:${fillZero(postTime.getMinutes())}`;
      }
      //删除消息
      function deletePost(event) {
        const confir = confirm("确定要删除吗？");
        if (confir) {
          event.currentTarget.parentNode.parentNode.parentNode.remove();
          api.deletePosts(event.currentTarget.id);
          myAlert.alertSuccess("删除成功");
        } else {
          return;
        }

        // render();
      }
      //创建一个输入框,代替消息内容
      function createTextAera(event, content) {
        const newTextArea = document.createElement("textarea");
        newTextArea.classList.add("input-content");
        newTextArea.classList.add("post-submit");
        newTextArea.rows = "5";
        newTextArea.value = content;
        event.currentTarget.parentNode.parentNode.previousSibling.replaceWith(
          newTextArea
        );
      }
      //创建确认按钮，代替编辑按钮
      function createConfirmButton(event, postId) {
        // console.log(event.currentTarget.parentNode.parentNode.parentNode.firstElementChild.value);
        // const post_id= postId
        // const content = event.currentTarget.parentNode.parentNode.parentNode.firstElementChild.value
        const confirmButton = document.createElement("button");
        confirmButton.classList.add("confirm");
        confirmButton.innerText = "确认";
        // console.log(content);
        // console.log(post_id);
        confirmButton.onclick = async function (event) {
          // console.log(createConfirmButton.content);
          // const post_id = event.currentTarget.nextSibling.id;
          const content =
            event.currentTarget.parentNode.parentNode.parentNode
              .firstElementChild.value;
          await api.editPosts(postId, content);
          render();
          myAlert.alertSuccess("消息更新成功");
        };
        event.currentTarget.replaceWith(confirmButton);
      }
      //创建取消按钮，代替删除按钮
      function createCancelButton(event) {
        const cancelButton = document.createElement("button");
        cancelButton.classList.add("cancel");
        cancelButton.innerText = "取消";
        console.log(event.currentTarget);
        event.currentTarget.nextSibling.replaceWith(cancelButton);
        cancelButton.onclick = () => {
          render();
        };
      }
      //编辑消息
      function editPost(event) {
        const postId = event.currentTarget.nextSibling.id;
        const content =
          event.currentTarget.parentNode.parentNode.previousSibling.innerText;
        createTextAera(event, content);
        createCancelButton(event, postId);
        createConfirmButton(event, postId);
        // const editingPost = document.querySelector(".input-dialog");
        // console.log(editingPost.firstElementChild);
        // editingPost.firstElementChild.value =
        //     event.currentTarget.parentNode.parentNode.previousSibling.innerText;
        //     event.currentTarget.parentNode.parentNode.firstElementChild.replaceWith(editingPost.firstElementChild)
        // event.currentTarget.parentNode.parentNode.parentNode.replaceWith(
        //     editingPost
        // );

        // event.currentTarget.parentNode.parentNode.parentNode.innerHTML = `
        //     <div class="post input-dialog">
        //         <textarea
        //             class="input-content"
        //             rows="5"
        //         >${event.currentTarget.parentNode.parentNode.previousSibling.innerText}</textarea>
        //         <div class="buttons">
        //             <button class="confirm">确认</button>
        //             <button class="cancel" onclick="cancel">取消</button>
        //         </div>
        //     </div>`;
      }
      //搜索功能，过滤满足条件的内容
      function search(event) {
        let searchContent = "";
        searchContent = event.currentTarget.parentNode.firstElementChild.value;
        // console.log(searchContent);
        event.currentTarget.onclick = async function filterPost() {
          const filteredPosts = await api.getPosts();
          const arr = filteredPosts.results.filter(function (data) {
            return data.content.indexOf(searchContent) === -1 ? false : true;
          });
          //console.log(arr);
          createDom(arr);
        };
      }
      //清除功能
      function clear() {
        event.currentTarget.parentNode.firstElementChild.value = "";
        render();
      }
      //...........................
      render();
    </script>
  </head>
  <body>
    <div class="container">
      <header>
        <h2>消息墙</h2>
        <div class="search">
          <input type="text" placeholder="输入你要搜索的内容" />
          <button class="searchButton">搜索</button>
          <button class="clearButton">清除</button>
        </div>
      </header>
      <main>
        <div class="post-submit" hidden>
          <div class="post input-dialog">
            <textarea
              class="input-content"
              placeholder="请输入消息"
              rows="5"
            ></textarea>
            <div class="buttons">
              <button class="confirm">确认</button>
              <button class="cancel">取消</button>
            </div>
          </div>
        </div>
        <div class="posts">
          <!-- <div class="post">
                      <p>New Message : Hello World</p>
                      <div class="post-bottom">
                        <span>2022-11-23 09:29</span>
                        <div>
                          <button class="edit">编辑</button>
                          <button class="delete">删除</button>
                        </div>
                      </div>
                    </div> -->
        </div>
      </main>
      <button class="submit">发布</button>
    </div>
  </body>
</html>
